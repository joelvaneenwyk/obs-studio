@echo off
goto:$Main

:SetSubmodule %BRANCH% %NAME% %URL% %PATH%
setlocal EnableDelayedExpansion
    set "_branch=%~1"
    set "_repository=%~2"
    set "_path=%~3"
    set "_local_path=!_path:/=\!"
    echo Set submodule "!_repository!" on branch "!_branch!" at path "!_path!".
    git rm -r --cached "!_path!"
    if exist "!_local_path!" rmdir /q /s "!_local_path!"
    if exist "!_local_path!" del "!_local_path!"
    git submodule deinit --force -- "!_path!"
    git submodule add --branch "!_branch!" --force -- "!_repository!" "!_path!"
    git submodule set-url -- "!_path!" "!_repository!"
endlocal & exit /b %ERRORLEVEL%

:SetupSubmodules
    call :SetSubmodule ^
            "master" ^
            "https://github.com/Xaymar/cmake-clang.git" ^
	    "UI/frontend-plugins/streamfx/cmake/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/Xaymar/cmake-version.git" ^
	    "UI/frontend-plugins/streamfx/cmake/version/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/nlohmann/json.git" ^
	    "UI/frontend-plugins/streamfx/third-party/nlohmann-json/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/Xaymar/msvc-redist-helper.git" ^
	    "UI/frontend-plugins/streamfx/third-party/msvc-redist-helper/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/NVIDIA/MAXINE-AR-SDK.git" ^
	    "UI/frontend-plugins/streamfx/third-party/nvidia-maxine-ar-sdk/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/NVIDIA/MAXINE-VFX-SDK.git" ^
	    "UI/frontend-plugins/streamfx/third-party/nvidia-maxine-vfx-sdk/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/obsproject/obs-studio.git" ^
	    "UI/frontend-plugins/streamfx/third-party/obs-studio/"
    call :SetSubmodule ^
            "master" ^
            "https://github.com/NVIDIA/MAXINE-AFX-SDK.git" ^
	    "UI/frontend-plugins/streamfx/third-party/nvidia-maxine-afx-sdk/"
exit /b %ERRORLEVEL%

:$Main
setlocal EnableDelayedExpansion
    set CI=1
    set "_root=%~dp0"
    set "_root=!_root:/=\!"
    if "!_root:~-1!"=="\" set "_root=!_root:~0,-1!"

    cd /d "!_root!"

    git -C "!_root!" submodule update --recursive --remote --checkout

    if not exist "!_root!\.build" mkdir "!_root!\.build"
    if not exist "!_root!\.build\obsdeps" mkdir "!_root!\.build\obsdeps"
    if not exist "!_root!\.build\output" mkdir "!_root!\.build\output"

    call "C:\Program Files\PowerShell\7\pwsh.exe" -NoProfile -File "!_root!\.github\scripts\Build-Windows.ps1"

    cmake -S "!_root!\" -B "!_root!\.build" -DCMAKE_PREFIX_PATH="!_root!\.build\output"
endlocal & exit /b %ERRORLEVEL%

REM AUTOGENERATED COPYRIGHT HEADER START
REM Copyright (C) 2020-2023 Michael Fabian 'Xaymar' Dirks <info@xaymar.com>
REM AUTOGENERATED COPYRIGHT HEADER END
REM [submodule "cmake/clang"]
REM 	path = cmake/clang
REM 	url = https://github.com/Xaymar/cmake-clang.git
REM [submodule "cmake/version"]
REM 	path = cmake/version
REM 	url = https://github.com/Xaymar/cmake-version.git
REM [submodule "third-party/nlohmann-json"]
REM 	path = third-party/nlohmann-json
REM 	url = https://github.com/nlohmann/json.git
REM [submodule "third-party/msvc-redist-helper"]
REM 	path = third-party/msvc-redist-helper
REM 	url = https://github.com/Xaymar/msvc-redist-helper.git
REM [submodule "third-party/nvidia-maxine-ar-sdk"]
REM 	path = third-party/nvidia-maxine-ar-sdk
REM 	url = https://github.com/NVIDIA/MAXINE-AR-SDK.git
REM [submodule "third-party/nvidia-maxine-vfx-sdk"]
REM 	path = third-party/nvidia-maxine-vfx-sdk
REM 	url = https://github.com/NVIDIA/MAXINE-VFX-SDK.git
REM [submodule "third-party/obs-studio"]
REM 	path = third-party/obs-studio
REM 	url = https://github.com/obsproject/obs-studio.git
REM [submodule "third-party/nvidia-maxine-afx-sdk"]
REM 	path = third-party/nvidia-maxine-afx-sdk
REM 	url = https://github.com/NVIDIA/MAXINE-AFX-SDK.git
